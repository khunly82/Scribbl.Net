@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@using Scribbl.Net.Models

<MudGrid Spacing="2">
    <MudItem sm="12" md="3">
        <MudCard>
            <MudCardContent>
                <MudColorPicker
                    Label="Couleur"
                    @bind-Text="color"
                    PickerVariant="PickerVariant.Static"
                    ShowColorField=false
                    ></MudColorPicker>
                <MudSelect Label="Epaisseur" @bind-Value="thickness">
                    <MudSelectItem Value="@(1)">1</MudSelectItem>
                    <MudSelectItem Value="@(2)">2</MudSelectItem>
                    <MudSelectItem Value="@(3)">3</MudSelectItem>
                    <MudSelectItem Value="@(4)">4</MudSelectItem>
                    <MudSelectItem Value="@(5)">5</MudSelectItem>
                </MudSelect>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           @onclick="ClearCanvas"
                >Effacer Tout</MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           @onclick="Back">Retour en arrière</MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>
    <MudItem sm="12" md="7">
        <canvas @ref="canvas"
                height="600"
                width="800"
                style="border: 1px solid black"
                @onmousedown="StartDraw"
                @onmouseup="EndDraw"
                @onmouseleave="EndDraw"
                @onmousemove="Draw"></canvas>
    </MudItem>
    <MudItem sm="12" md="2">
        <MudCard>
            <MudCardContent></MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>



@code {
    private ElementReference canvas;

    private bool drawing = false;

    private double fromX;
    private double fromY;

    private string color = "#000000";
    private int thickness = 2;

    private List<Line> lastSequence = [];

    [Inject]
    public IJSRuntime JS { get; set; }

    private HubConnection connection;

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        HubConnectionBuilder builder = new();
        builder.WithUrl("http://10.10.10.2:8838/ws/game");
        connection = builder.Build();
        connection.On<Line>("DrawLine", l =>
        {
            // 4
            // lorsque un autre user ajoute un trait
            // qu'est que je fais ?
            JS.InvokeVoidAsync("drawLine", canvas, l.FromX, l.FromY, l.ToX, l.ToY, l.Color, l.Thickness);

        });

        connection.On("ClearCanvas", () =>
        {
            JS.InvokeVoidAsync("clearCanvas", canvas);
        });

        connection.On<List<List<Line>>>("Redraw", async p =>
        {
            await JS.InvokeVoidAsync("clearCanvas", canvas);
            foreach (Line l in p.SelectMany(li => li))
            {
                await JS.InvokeVoidAsync("drawLine", canvas, l.FromX, l.FromY, l.ToX, l.ToY, l.Color, l.Thickness);
            }
        });
        await connection.StartAsync();
    }

    private void StartDraw(MouseEventArgs e)
    {
        drawing = true;
        fromX = e.OffsetX;
        fromY = e.OffsetY;
    }

    private void Draw(MouseEventArgs e)
    {
        if (!drawing) return;

        // 1
        JS.InvokeVoidAsync("drawLine", canvas, fromX, fromY, e.OffsetX, e.OffsetY, color, thickness);

        // 2
        lastSequence.Add(new Line
        {
            FromX = fromX,
            FromY = fromY,
            ToX = e.OffsetX,
            ToY = e.OffsetY,
            Color = color,
            Thickness = thickness,
        });
        connection.SendAsync("DrawLine", lastSequence[^1]);
        fromX = e.OffsetX;
        fromY = e.OffsetY;
    }

    public void ClearCanvas()
    {
        // 1
        JS.InvokeVoidAsync("clearCanvas", canvas);
        // 2
        connection.SendAsync("ClearCanvas");
    }

    public void EndDraw()
    {
        drawing = false;
        if(lastSequence.Any())
        {
            connection.SendAsync("SendSequence", lastSequence);
            lastSequence.Clear();
        }
    }

    public void Back()
    {
        connection.SendAsync("Back");
    }
}
